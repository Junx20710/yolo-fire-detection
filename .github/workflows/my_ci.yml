name: Fire Detection CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # === 任务 1: CI (测试) ===
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
          cache: 'pip'

      - name: Install Linux Libs
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install torch==1.13.1+cpu torchvision==0.14.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu
          if [ -f requirements-ci.txt ]; then pip install -r requirements-ci.txt; fi

      - name: Run Tests
        run: pytest tests/test_yolo_integration.py -v

  # === 任务 2: CD (构建与发布) ===
  build-and-push:
    # 关键点：只有测试通过了，才执行发布！
    needs: integration-test
    runs-on: ubuntu-latest
    # 只在推送到 main 分支时执行 CD，PR 不发版
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2. 构建并推送镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # 标签：你的用户名/仓库名:latest
          tags: ${{ secrets.DOCKER_USERNAME }}/yolo-fire-detection:latest