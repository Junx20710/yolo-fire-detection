name: Fire Detection CI

# 2. 触发机制 (Trigger)
# 面试官问：什么时候跑测试？
# 答：当我把代码 push 到 main 分支，或者有人给我提 PR 的时候。
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 3. 定义任务 (Jobs)
jobs:
  # 任务ID: integration-test
  integration-test:
    # 运行环境：租一台最新的 Ubuntu
    runs-on: ubuntu-latest
    
    # 4. 步骤 (Steps) - 核心逻辑
    steps:
    # Step A: 拉取代码
    # 相当于在云端执行了 git clone
    - name: Checkout code
      uses: actions/checkout@v3

    # Step B: 配置 Python 环境
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
        cache: 'pip' # 开启缓存，这是从官方配置里学来的好习惯！

    # Step C: 安装系统依赖 (官方配置没写这个，但我们需要！)
    # 因为我们要跑 OpenCV，云端环境没有图形界面，必须装这个
    - name: Install Linux Libs
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx

    # Step D: 安装 Python 依赖 (参考了官方的写法)
    # --extra-index-url .../cpu 是关键！只下 CPU 版 PyTorch，速度快 10 倍。
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        pip install -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu

    # Step E: 运行测试
    # 这里运行我们刚才写的那个 test_yolo_integration.py
    - name: Run Custom Tests
      run: |
        pytest tests/test_yolo_integration.py -v